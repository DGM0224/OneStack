<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">
<head>
    <link th:href="@{/css/community.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

</head>
<div layout:fragment="content" class="container py-5">
    <th:block>
        <form name="communityCheckForm" id="communityCheckForm">
            <input type="hidden" name="communityBoardNo" id="communityBoardNo" th:value="${community.communityBoardNo}"/>
            <input type="hidden" name="pageNum" th:value="${pageNum}"/>
            <th:block th:if="${searchOption}">
                <input type="hidden" name="type" th:value="${ type }" />
                <input type="hidden" name="keyword" th:value="${ keyword }" />
            </th:block>
        </form>
        <div class="row mt-5">
            <div class="col-md">
                <a href="#" th:onclick="@{|location.href='communityList?pageNum=${pageNum}'|}" style="text-decoration: none; color: inherit;">
                    <span class="fw-bold">자유 게시판</span>
                </a>
            </div>
        </div>
        <div class="row d-flex justify-content-between my-3">
            <div class="col-auto">
                <small class="text-muted" th:text="${#dates.format(community.communityBoardRegDate, 'yyyy.MM.dd HH:mm')}">작성 날짜</small>
            </div>
            <div class="col-auto dropdown-container communityDropdownContainer">
                <i class="bi bi-three-dots" onclick="toggleDropdown(this)"></i>
                <div class="dropdown-menu communityDropdown" style="display: none;">
                    <a class="dropdown-item communityDropdownItem"
                       th:if="${session.member != null and session.member.memberNo == community.memberNo}"
                       th:href="@{/communityUpdateForm(communityBoardNo=${community.communityBoardNo})}">
                        수정하기
                    </a>
                    <form th:action="@{/delete}" method="post" style="display:inline;">
                        <input type="hidden" name="communityBoardNo" th:value="${community.communityBoardNo}"/>
                        <input type="hidden" name="memberNo" th:value="${session.member.memberNo}"/>
                        <button type="submit" class="dropdown-item communityDropdownItem" th:if="${session.member != null and session.member.memberNo == community.memberNo}">
                            삭제하기
                        </button>
                    </form>
                    <a class="dropdown-item communityDropdownItem"
                       th:if="${session.member != null and session.member.memberNo != community.memberNo}"
                       th:href="@{/report(communityBoardNo=${community.communityBoardNo})}">
                        신고하기
                    </a>
                </div>
            </div>
        </div>

        <div class="row d-flex justify-content-between">
            <div class="col-auto">
                <span th:text="${community.memberNo}">작성자</span>
            </div>
            <div class="col-auto">
                <span class="text-muted ms-2">조회수 <span th:text="${community.communityView}">0</span></span>
            </div>
        </div>

        <div class="row mt-5 mx-3">
            <div class="col">
                <h3 th:text="${community.communityBoardTitle}">게시물 제목</h3>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <hr class="my-4 opacity-25">
            </div>
        </div>

        <div class="row mx-3">
            <div class="col">
                <div class="ql-editor" th:utext="${community.communityBoardContent}"></div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div th:if="${community.communityFile != null}" class="text-center mb-4">
                    <img th:src="@{/uploads/{filename}(filename=${community.communityFile})}" class="img-fluid rounded" alt="게시물 이미지">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <hr class="my-4 opacity-25">
            </div>
        </div>

        <div class="row d-flex justify-content-between align-items-center">
            <div class="d-flex gap-3 col-auto">
                <!-- 좋아요 버튼 -->
                <span id="communityBoardLike" class="recommend-btn"
                      th:with="isAuthor=${session.member != null && session.member.memberNo == community.memberNo}"
                      th:style="${!isAuthor && session.member != null} ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;'"
                      th:data-board-no="${community.communityBoardNo}"
                      th:data-is-author="${isAuthor}"
                      th:classappend="${community.communityBoardLike > 0} ? 'active' : ''">
            <i class="bi" th:classappend="${community.communityBoardLike > 0} ? 'bi-heart-fill text-danger' : 'bi-heart'"></i>
            좋아요 <span class="like-count" th:text="${community.communityBoardLike}">0</span>
        </span>

                <!-- 싫어요 버튼 -->
                <span id="communityBoardDislike" class="recommend-btn"
                      th:with="isAuthor=${session.member != null && session.member.memberNo == community.memberNo}"
                      th:style="${!isAuthor && session.member != null} ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;'"
                      th:data-board-no="${community.communityBoardNo}"
                      th:data-is-author="${isAuthor}"
                      th:classappend="${community.communityBoardDislike > 0} ? 'active' : ''">
            <i class="bi" th:classappend="${community.communityBoardDislike > 0} ? 'bi-hand-thumbs-down-fill text-primary' : 'bi-hand-thumbs-down'"></i>
            싫어요 <span class="dislike-count" th:text="${community.communityBoardDislike}">0</span>
        </span>
            </div>
            <div class="d-flex gap-3 col-auto text-end"><span><i class="bi bi-chat"></i> 댓글 <span th:text="${community.communityReplyCount}">0</span></span>
            </div>
        </div>



        <div class="row mt-4">
            <div class="col">
                <div class="card mb-2">
                    <div class="card-body">
                        <form id="replyForm" class="d-flex gap-2">
                            <input type="hidden" name="communityBoardNo" th:value="${community.communityBoardNo}"/>
                            <input type="hidden" name="memberNo" th:value="${session.member.memberNo}"/>
                            <div class="flex-grow-1">
                                <input type="text" class="form-control" placeholder="댓글을 입력하세요" name="communityReplyContent"/>
                            </div>
                            <button type="submit" class="btn btn-primary">등록</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- 댓글 목록 -->
        <th:block th:if="${not #lists.isEmpty(replyList)}">
            <div class="row mt-4" id="replyList" th:each="reply : ${replyList}">
        <div class="card mb-2">
            <div class="card-body">
                <form>
                    <input type="hidden" name="communityReplyNo" th:value="${reply.communityReplyNo}">
                    <input type="hidden" name="communityBoardNo" th:value="${reply.communityBoardNo}">
                    <input type="hidden" name="memberNo" th:value="${reply.memberNo}">
                    <input type="hidden" name="communityReplyActivation" value="1">
                </form>
                <div class="row d-flex justify-content-between">
                    <div class="col-auto">
                        <h6 class="card-subtitle mb-2 text-muted" th:text="${reply.nickname}">작성자</h6>
                    </div>
                        <div class="col-auto dropdown-container communityDropdownContainer communityReplyDelete"
                             th:if="${session.member != null && session.member.memberNo == reply.memberNo}">
                            <i class="bi bi-three-dots" onclick="toggleDropdown(this)"></i>
                            <div class="dropdown-menu communityDropdown" style="display: none;">
                                <a class="dropdown-item communityDropdownItem" href="#">수정하기</a>
                                <form action="/replyDelete" method="post" style="display:inline;">
                                    <input type="hidden" name="communityReplyNo" th:value="${reply.communityReplyNo}"/>
                                    <input type="hidden" name="memberNo" th:value="${reply.memberNo}"/>
                                    <button type="submit" class="dropdown-item communityDropdownItem">삭제하기</button>
                                </form>
                                <a class="dropdown-item communityDropdownItem" href="#">신고하기</a>
                            </div>
                    </div>
                </div>
                <div class="row">
                    <p class="card-text" th:text="${reply.communityReplyContent}">댓글 내용이 여기에 표시됩니다.</p>
                </div>
                <div class="row">
                    <div class="d-flex gap-2 text-muted">
                        <small th:text="${#dates.format(reply.communityReplyRegDate, 'yyyy-MM-dd HH:mm')}">작성일</small>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </th:block>
    </th:block>
</div>
<!-- communityWrite.js 스크립트 포함 -->
<th:block layout:fragment="script">
    <script th:src="@{/js/communityWrite.js}"></script>
    <script th:src="@{/js/communityReply.js}"></script>
    <script th:src="@{/js/header.js}"></script>
        <script>
            // 이미지 로딩 에러 처리
            document.querySelectorAll('.ql-editor img').forEach(img => {
                img.onerror = function() {
                    this.style.display = 'none';
                    console.log('이미지 로딩 실패:', this.src);
                };
            });

            // 링크 새 창에서 열기
            document.querySelectorAll('.ql-editor a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
        </script>
    </th:block>


</th:block>
</html>